{% extends "base.html" %}

{% block title %}Estatísticas{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Estatísticas da Barbearia</h1>

    <!-- Card de Estatísticas Principais -->
    <div class="row">
        <div class="col-md-6">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total de Clientes Atendidos</h5>
                    <p class="card-text">{{ total_clientes_atendidos }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total de Produtos Vendidos</h5>
                    <p class="card-text">{{ total_produtos_vendidos }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Cortes Mais Populares e Produtos -->
    <div class="row mb-4">
        <!-- Cortes Mais Populares -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Cortes Mais Populares</h5>
                    <div class="table-responsive">
                        <table id="cortes-table" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nome do Corte</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody id="cortes-lista">
                                {% for corte in cortes_populares %}
                                <tr>
                                    <td>{{ corte.tipo_corte__nome }}</td>
                                    <td>{{ corte.total }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="cortes-pagination">
                            <li class="page-item"><a class="page-link" href="#" id="prev-cortes">Anterior</a></li>
                            <li class="page-item"><a class="page-link" href="#" id="next-cortes">Próximo</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        <!-- Tabela de Produtos Cadastrados -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Produtos Cadastrados</h5>
                    <div class="table-responsive">
                        <table id="produtos-table" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Qtd Vendida</th>
                                    <th>Qtd em Estoque</th>
                                </tr>
                            </thead>
                            <tbody id="produtos-lista">
                                {% for produto in produtos %}
                                <tr>
                                    <td>{{ produto.nome }}</td>
                                    <td>
                                        {% with total_vendido=produtos_vendidos %}
                                        {% for item in total_vendido %}
                                        {% if item.produtos__nome == produto.nome %}
                                        {{ item.total_vendido }}
                                        {% endif %}
                                        {% endfor %}
                                        {% endwith %}
                                    </td>
                                    <td>{{ produto.estoque }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="produtos-pagination">
                            <li class="page-item"><a class="page-link" href="#" id="prev-produtos">Anterior</a></li>
                            <li class="page-item"><a class="page-link" href="#" id="next-produtos">Próximo</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Clientes Fiéis com Paginação e Aniversariantes do Mês -->
    <div class="row mb-4">
        <!-- Lista de Clientes Fiéis -->
        <div class="card mb-4 col-md-6">
            <div class="card-body">
                <h5 class="card-title">Lista de Clientes Fiéis</h5>
                <div class="table-responsive">
                    <table id="clientes-table" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome Completo</th>
                                <th>Data de Nascimento</th>
                                <th>Qtd Cortes</th>
                            </tr>
                        </thead>
                        <tbody id="clientes-lista">
                            {% for cliente in clientes_fieis %}
                            <tr>
                                <td>{{ cliente.nome }}</td>
                                <td>{{ cliente.data_nascimento|date:"d/m" }}</td>
                                <td>{{ cliente.total_visitas }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center" id="clientes-pagination">
                        <li class="page-item"><a class="page-link" href="#" id="prev-page">Anterior</a></li>
                        <li class="page-item"><a class="page-link" href="#" id="next-page">Próximo</a></li>
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Aniversariantes do Mês -->
        <div class="card mb-4 col-md-6">
            <div class="card-body">
                <h5 class="card-title">Aniversariantes do Mês</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome Completo</th>
                                <th>Data de Nascimento</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for aniversariante in aniversariantes_do_mes %}
                            <tr>
                                <td>{{ aniversariante.nome }}</td>
                                <td>{{ aniversariante.data_nascimento|date:"d/m" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Paginação e Javascript para Atualizar Tabelas -->
<script>
    let currentPageClientes = 1;
    let currentPageCortes = 1;
    let currentPageProdutos = 1;
    const rowsPerPage = 5; // Número de registros por página

    function paginate(tableId, page, rows) {
        const rowsElement = document.querySelectorAll(`${tableId} tbody tr`);
        rowsElement.forEach((row, index) => {
            row.style.display = (index >= (page - 1) * rows && index < page * rows) ? '' : 'none';
        });
    }

    function updatePagination(paginationId, currentPage, totalPages) {
        const prevButton = document.querySelector(`${paginationId} #prev-page`);
        const nextButton = document.querySelector(`${paginationId} #next-page`);

        prevButton.parentElement.classList.toggle("disabled", currentPage === 1);
        nextButton.parentElement.classList.toggle("disabled", currentPage >= totalPages);
    }

    // Funções de Eventos para as Tabelas
    document.getElementById("prev-page").addEventListener("click", function (e) {
        e.preventDefault();
        if (currentPageClientes > 1) {
            currentPageClientes--;
            paginate("#clientes-table", currentPageClientes, rowsPerPage);
            updatePagination("#clientes-pagination", currentPageClientes, Math.ceil(document.querySelectorAll("#clientes-lista tr").length / rowsPerPage));
        }
    });

    document.getElementById("next-page").addEventListener("click", function (e) {
        e.preventDefault();
        if (currentPageClientes < Math.ceil(document.querySelectorAll("#clientes-lista tr").length / rowsPerPage)) {
            currentPageClientes++;
            paginate("#clientes-table", currentPageClientes, rowsPerPage);
            updatePagination("#clientes-pagination", currentPageClientes, Math.ceil(document.querySelectorAll("#clientes-lista tr").length / rowsPerPage));
        }
    });

    document.getElementById("prev-cortes").addEventListener("click", function (e) {
        e.preventDefault();
        if (currentPageCortes > 1) {
            currentPageCortes--;
            paginate("#cortes-table", currentPageCortes, rowsPerPage);
            updatePagination("#cortes-pagination", currentPageCortes, Math.ceil(document.querySelectorAll("#cortes-lista tr").length / rowsPerPage));
        }
    });

    document.getElementById("next-cortes").addEventListener("click", function (e) {
        e.preventDefault();
        if (currentPageCortes < Math.ceil(document.querySelectorAll("#cortes-lista tr").length / rowsPerPage)) {
            currentPageCortes++;
            paginate("#cortes-table", currentPageCortes, rowsPerPage);
            updatePagination("#cortes-pagination", currentPageCortes, Math.ceil(document.querySelectorAll("#cortes-lista tr").length / rowsPerPage));
        }
    });

    document.getElementById("prev-produtos").addEventListener("click", function (e) {
        e.preventDefault();
        if (currentPageProdutos > 1) {
            currentPageProdutos--;
            paginate("#produtos-table", currentPageProdutos, rowsPerPage);
            updatePagination("#produtos-pagination", currentPageProdutos, Math.ceil(document.querySelectorAll("#produtos-lista tr").length / rowsPerPage));
        }
    });

    document.getElementById("next-produtos").addEventListener("click", function (e) {
        e.preventDefault();
        if (currentPageProdutos < Math.ceil(document.querySelectorAll("#produtos-lista tr").length / rowsPerPage)) {
            currentPageProdutos++;
            paginate("#produtos-table", currentPageProdutos, rowsPerPage);
            updatePagination("#produtos-pagination", currentPageProdutos, Math.ceil(document.querySelectorAll("#produtos-lista tr").length / rowsPerPage));
        }
    });

    // Inicializa a paginação
    paginate("#clientes-table", currentPageClientes, rowsPerPage);
    updatePagination("#clientes-pagination", currentPageClientes, Math.ceil(document.querySelectorAll("#clientes-lista tr").length / rowsPerPage));

    paginate("#cortes-table", currentPageCortes, rowsPerPage);
    updatePagination("#cortes-pagination", currentPageCortes, Math.ceil(document.querySelectorAll("#cortes-lista tr").length / rowsPerPage));

    paginate("#produtos-table", currentPageProdutos, rowsPerPage);
    updatePagination("#produtos-pagination", currentPageProdutos, Math.ceil(document.querySelectorAll("#produtos-lista tr").length / rowsPerPage));
</script>

{% endblock %}
